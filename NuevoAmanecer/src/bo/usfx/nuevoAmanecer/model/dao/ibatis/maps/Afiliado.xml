<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="Afiliado">

	<sql id="PropertiesAfiliado">
		SELECT 
		  familia.codigo_persona, 
		  familia.ci, 
		  familia.apellido_paterno, 
		  familia.nombres, 
		  familia.parentesco, 
		  familia.apellido_materno, 
		  familia.sexo, 
		  familia.fecha_nacimiento, 
		  familia.con_certificado, 
		  familia.alfabetizado, 
		  familia.fecha_alfetizacion, 
		  familia.codigo_actividad_educactiva, 
		  familia.codigo_estado_familia,
		  familia.ruta_archivo_imagen,
		  CASE WHEN familia.codigo_ocupacion IS NULL THEN -1 ELSE familia.codigo_ocupacion END AS codigo_ocupacion, 
		  familia.tipo_ocu, 
		  familia.codigo_evento_vital, 
		  familia.codigo_causa_muerte, 
		  familia.numero_familia, 
		  afiliado.numero_caso, 		  
		  afiliado.tipo, 
		  afiliado.nombre_corto, 
		  afiliado.vacuna_nino, 
		  CASE WHEN afiliado.numero_nino IS NULL THEN -1 ELSE afiliado.numero_nino END AS numero_nino,
		  causas_muerte.nommbre_causa_muerte, 
		  eventos_vitales.nombre_evento_vital, 
		  ocupaciones.nombre_ocupacion, 
		  actividad_educativa.nombre_actividad_educativa
		FROM 
		  public.familia
		  INNER JOIN public.afiliado
		  ON familia.codigo_persona = afiliado.codigo_persona		  
		  LEFT JOIN public.causas_muerte
		  ON familia.codigo_causa_muerte = causas_muerte.codigo_causa_muerte
		  LEFT JOIN public.eventos_vitales
		  ON familia.codigo_evento_vital = eventos_vitales.codigo_evento_vital
		  LEFT JOIN public.ocupaciones
		  ON familia.codigo_ocupacion = ocupaciones.codigo_ocupacion
		  LEFT JOIN public.actividad_educativa
		  ON familia.codigo_actividad_educactiva = actividad_educativa.codigo_actividad_educactiva
		  
<!-- 
		  AND estaTarjetaHabilitada(familia.numero_familia) = true
		  AND familia.codigo_Estado_familia = 'H' -->

  </sql>
	
	<resultMap id="listaAfiliados" class="Afiliado">
		<result property="codigo_persona" column="codigo_persona" />
		<result property="ci" column="ci" />
		<result property="nombres" column="nombres" />
		<result property="apellido_paterno" column="apellido_paterno" />
		<result property="apellido_materno" column="apellido_materno" />
		<result property="parentesco" column="parentesco" />
		<result property="sexo" column="sexo" />
		<result property="fecha_nacimiento" column="fecha_nacimiento" />
		<result property="con_certificado" column="con_certificado" />
		<result property="alfabetizado" column="alfabetizado" />
		<result property="fecha_alfetizacion" column="fecha_alfetizacion" />
		<result property="codigo_actividad_educactiva" column="codigo_actividad_educactiva" />
		<result property="tipo_ocu" column="tipo_ocu" />
		<result property="codigo_evento_vital" column="codigo_actividad_educactiva" />
		<result property="codigo_causa_muerte" column="codigo_causa_muerte" />
		<result property="numero_familia" column="numero_familia" />
		<result property="ruta_archivo_imagen" column="ruta_archivo_imagen" />		
		<result property="codigo_estado_familia" column="codigo_estado_familia" />
		<result property="ocupacion.codigo_ocupacion" column="codigo_ocupacion" />
		<result property="ocupacion.nombre_ocupacion" column="nombre_ocupacion" />
		<result property="actividadEducativa.codigo_actividad_educactiva" column="codigo_actividad_educactiva" />
		<result property="actividadEducativa.nombre_actividad_educativa" column="nombre_actividad_educativa" />
		<result property="eventoVital.codigo_evento_vital" column="codigo_evento_vital" />
		<result property="eventoVital.nombre_evento_vital" column="nombre_evento_vital" />
		<result property="causaMuerte.codigo_causa_muerte" column="codigo_causa_muerte" />
		<result property="causaMuerte.nommbre_causa_muerte" column="nommbre_causa_muerte" />
		<result property="numero_caso" column="numero_caso" />
		<result property="tipo" column="tipo" />
		<result property="nombre_corto" column="nombre_corto" />
		<result property="vacuna_nino" column="vacuna_nino" />	
		<result property="numero_nino" column="numero_nino" />	
		
	</resultMap>
	
	<select id="ObtenerAfiliado" resultMap="listaAfiliados">
		<include refid="PropertiesAfiliado" />
		<dynamic prepend="WHERE">
			<isGreaterThan property="codigo_persona" compareValue="0" prepend="AND">
				familia.codigo_persona = #codigo_persona#
			</isGreaterThan>
			<isGreaterThan property="numero_caso" compareValue="0" prepend="AND">
				numero_caso = #numero_caso#
			</isGreaterThan>
		</dynamic>
		ORDER BY apellido_paterno ASC
	</select>

	<select id="BuscarAfiliado" resultMap="listaAfiliados">
		<include refid="PropertiesAfiliado" />		
		<dynamic prepend="WHERE">
			<iterate property="keywordList" open="(" close=")"
				conjunction="OR">				
				cast(familia.codigo_persona as char(100)) like #keywordList[]# OR
				cast(numero_caso as char(100)) like #keywordList[]# OR				
				lower(nombres) like lower(#keywordList[]#) OR
				lower(apellido_paterno) like lower(#keywordList[]#) OR
				lower(apellido_materno) like lower(#keywordList[]#)
			</iterate>
			<isGreaterThan property="filtroEntero" compareValue="0" prepend="AND">
				And familia.codigo_persona not in
				(SELECT p.codigo_persona 
				FROM participa p
				WHERE p.codigo_programa = #filtroEntero#)
			</isGreaterThan>
		</dynamic>
		ORDER BY apellido_paterno ASC
	</select>
	
	<select id="VerificarIdAfiliado" resultClass="java.lang.Integer">
		SELECT count(codigo_persona)
		FROM Familia
		WHERE codigo_persona = #codigo_persona#;
  </select>

	<select id="VerificarExistenciaDescripcionAfiliado" resultClass="java.lang.Integer">
		SELECT count(*)
		FROM familia
		WHERE UPPER(TRIM(nombres)) = UPPER(TRIM(#nombres#))
		AND UPPER(TRIM(apellido_paterno)) = UPPER(TRIM(#apellido_paterno#))
		AND UPPER(TRIM(apellido_materno)) = UPPER(TRIM(#apellido_materno#))
	</select> 


	<insert id="InsertarAfiliado" parameterClass="Afiliado">
		INSERT INTO Familia(
            ci, nombres, apellido_paterno, apellido_materno, 
            parentesco, sexo, fecha_nacimiento, con_certificado, alfabetizado, 
            fecha_alfetizacion, codigo_actividad_educactiva, codigo_ocupacion, 
            tipo_ocu, codigo_evento_vital, codigo_causa_muerte, numero_familia, ruta_archivo_imagen)
		VALUES(#ci#, UPPER(TRIM(#nombres#)), UPPER(TRIM(#apellido_paterno#)), UPPER(TRIM(#apellido_materno#)), 
            #parentesco#, #sexo#, #fecha_nacimiento#, #con_certificado#, #alfabetizado#, 
            #fecha_alfetizacion#, #codigo_actividad_educactiva#, CASE WHEN #codigo_ocupacion# = -1 THEN NULL ELSE #codigo_ocupacion# END, 
            #tipo_ocu#, #codigo_evento_vital#, #codigo_causa_muerte#, #numero_familia#, #ruta_archivo_imagen#);
			
		INSERT INTO afiliado(numero_caso, tipo, nombre_corto, vacuna_nino, codigo_persona, numero_nino)            
			VALUES (#numero_caso#, #tipo#, #nombre_corto#, #vacuna_nino#, obtenerultimoidfamilia(''), CASE WHEN #numero_nino# = 0 or #numero_nino# = -1 THEN null else #numero_nino# end);

  </insert>

	<update id="ModificarAfiliado" parameterClass="Afiliado">
		UPDATE Familia
		<dynamic prepend="SET">
			<isNotNull prepend="," property="ci">ci=#ci#</isNotNull>
			<isNotNull prepend="," property="nombres">nombres=UPPER(TRIM(#nombres#))</isNotNull>
			<isNotNull prepend="," property="apellido_paterno">apellido_paterno=UPPER(TRIM(#apellido_paterno#))</isNotNull>
			<isNotNull prepend="," property="apellido_materno">apellido_materno=UPPER(TRIM(#apellido_materno#))</isNotNull>
			<isNotNull prepend="," property="parentesco">parentesco=#parentesco#</isNotNull>
			<isNotNull prepend="," property="sexo">sexo=#sexo#</isNotNull>
			<isNotNull prepend="," property="fecha_nacimiento">fecha_nacimiento=#fecha_nacimiento#</isNotNull>
			<isNotNull prepend="," property="con_certificado">con_certificado=#con_certificado#</isNotNull>
			<isNotNull prepend="," property="alfabetizado">alfabetizado=#alfabetizado#</isNotNull>
			<isNotNull prepend="," property="fecha_alfetizacion">fecha_alfetizacion=#fecha_alfetizacion#</isNotNull>
			<isNotNull prepend="," property="codigo_actividad_educactiva">codigo_actividad_educactiva=#codigo_actividad_educactiva#</isNotNull>
			<isGreaterThan prepend="," property="codigo_ocupacion" compareValue="0">codigo_ocupacion=#codigo_ocupacion#</isGreaterThan>
			<isNotNull prepend="," property="tipo_ocu">tipo_ocu=#tipo_ocu#</isNotNull>
			<isNotNull prepend="," property="codigo_evento_vital">codigo_evento_vital=#codigo_evento_vital#</isNotNull>
			<isNotNull prepend="," property="codigo_causa_muerte">codigo_causa_muerte=#codigo_causa_muerte#</isNotNull>
			<isNotNull prepend="," property="numero_familia">numero_familia=#numero_familia#</isNotNull>
			<isNotNull prepend="," property="codigo_estado_familia">codigo_estado_familia=#codigo_estado_familia#</isNotNull>
			<isNotNull prepend="," property="ruta_archivo_imagen">ruta_archivo_imagen=#ruta_archivo_imagen#</isNotNull>			
		</dynamic>
		WHERE codigo_persona = #codigo_persona#;
		
		
		UPDATE Afiliado
		<dynamic prepend="SET">
			<isNotNull prepend="," property="numero_caso">numero_caso=#numero_caso#</isNotNull>
			<isNotNull prepend="," property="tipo">tipo=#tipo#</isNotNull>
			<isNotNull prepend="," property="nombre_corto">nombre_corto=#nombre_corto#</isNotNull>
			<isNotNull prepend="," property="vacuna_nino">vacuna_nino=#vacuna_nino#</isNotNull>
			<isGreaterThan prepend="," property="numero_nino" compareValue="0">numero_nino = #numero_nino#</isGreaterThan>
		</dynamic>
		WHERE codigo_persona = #codigo_persona#;
	</update>
	<delete id="EliminarAfiliado">
                DELETE FROM afiliado_vacunas
                WHERE codigo_persona = #codigo_persona#;
                
                DELETE FROM eccd
                WHERE numero_caso = #numero_caso#;

		DELETE FROM Afiliado 
		WHERE codigo_persona = #codigo_persona#;
		
		DELETE FROM Familia
		WHERE codigo_persona = #codigo_persona#;
  </delete>
  <parameterMap id="parametros" class="java.util.Map">
		<parameter property="a" />
	</parameterMap>
	<procedure id="obtenerUltimoIdAfiliado" parameterMap="parametros" resultClass="int">
		{ call ObtenerUltimoIdFamilia(?) }
  </procedure> 
</sqlMap>